SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[loadDimArtist]

AS

--Load dimArtist Procedure
declare @stage nvarchar(max);
declare @counter int;
declare @countRows int;

set @counter = 1;
set @countRows = (select count(*) from json_stage);

drop table if exists #stage
select 
	*,
	ROW_NUMBER() OVER(ORDER BY file_dump) r_num
into
	#stage
from
	json_stage
;

WHILE @counter <= @countRows
BEGIN
set @stage = (select file_dump from #stage where r_num = @counter);

insert into dbo.dimArtist (mbid, name)
select
	*
from (
select 
	distinct
	json_value(value, '$.artist.mbid') artistMBID,
	json_value(value, '$.artist.name') artistName
from 
	openjson(@stage)
) stage

where not exists (select mbid from dbo.dimArtist a where a.mbid = stage.artistMBID)
SET @counter = @counter + 1

END

RETURN 0
GO
